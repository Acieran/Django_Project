{% extends 'base.html' %}

{% block content %}
    <div class="flower-detail">
        <h1>{{ flower.name }}</h1>
        {% if flower.image %}
            <img src="{{ flower.image.url }}" alt="{{ flower.name }}" width="50">
        {% else %}
            <p>No image</p>
        {% endif %}

        <div class="flower-info">
            <p class="price">{{ flower.price }} RUB</p>
            <p class="stock">Stock: {% if flower.stock > 0 %}{{ flower.stock }} in stock{% else %}Out of stock{% endif %}</p>
            <p class="description">{{ flower.description }}</p>
            <div class="quantity-control" style="display: flex; align-items: center; gap: 5px;">
                <button class="btn btn-sm btn-secondary decrement-btn">-</button>
                <label>
                    <input type="number" class="form-control quantity-input" value="0" min="0" data-flower-id="{{ flower.id }}"
                           style="width: auto; min-width: 2em; max-width: 4em; text-align: center" id="quantityInput">
                </label>
                <button class="btn btn-sm btn-secondary increment-btn">+</button>
            </div>

            <div class="button-group" style="display: flex; justify-content: space-between;">
                {% if flower.stock > 0 %}
    {#                <form method="post" action="{% url 'flowers:add-to-cart' flower.id %}">#}
    {#                    {% csrf_token %}#}
    {#                    {{ form.as_p }}  <!-- Or use a more customized form rendering -->#}
    {#                    <button type="submit" class="add-to-cart">Add to Cart</button>#}
    {#                </form>#}
                    {% if not user.is_authenticated %}
                        <form method="get" action="{% url 'account:login' %}">  <!-- Redirect to login upon submission -->
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary">Add to Cart</button>
                        </form>
                    {% else %}
                        <button class="btn btn-success add-to-cart-btn" data-flower-id="{{ flower.id }}">
                        <i class="fas fa-shopping-cart"></i> Добавить в корзину
                        </button>
                    {% endif %}
                {% else %}
                    <p class="out-of-stock">К сожалению, сейчас данного товара нет в наличии.</p>
                {% endif %}
                <a href="{% url 'flowers:flower-list' %}" class="btn btn-secondary mt-3">Назад</a>
            </div>
        </div>

        
    </div>

    <script>
        // JavaScript for Add to Cart (replace with your actual cart logic)
        const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
        addToCartButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const flowerId = button.dataset.flowerId;
                const quantityInput = document.querySelector(`input[data-flower-id="${flowerId}"]`);
                const quantity = parseInt(quantityInput.value);

                if (isNaN(quantity) || quantity <= 0) {
                    alert("Please enter a valid quantity (greater than 0).");
                    return; // Stop further execution if quantity is invalid
                }

                try {
                    const response = await fetch('/orders/add-to-cart/' + flowerId + '/', { // Adjust URL if needed
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken') //Important for CSRF protection
                        },
                        body: JSON.stringify({quantity: quantity})
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        const errorMessage = errorData.error || 'An error occurred while adding to cart.';
                        throw new Error(errorMessage); // Re-throw the error for handling below
                    }

                    const data = await response.json();
                    if (data.success) {
                        alert("Item added to cart successfully!");
                        quantityInput.value = 0; //Reset quantity input
                    } else {
                        alert(data.message);
                    }


                } catch (error) {
                    console.error("Error adding to cart:", error);
                    alert('Error adding to cart: ' + error.message);
                }
            });
        });
        
        // Helper function to get CSRF token from cookie (for CSRF protection)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>


    <script>
        //JavaScript for quantity control
        const incrementButtons = document.querySelectorAll('.increment-btn');
        const decrementButtons = document.querySelectorAll('.decrement-btn');
        const quantityInput = document.getElementById("quantityInput");


        incrementButtons.forEach(button => {
            button.addEventListener('click', () => {
                const stock = {{ flower.stock }};
                quantityInput.value = Math.min(stock,parseInt(quantityInput.value) + 1);
            });
        });

        decrementButtons.forEach(button => {
            button.addEventListener('click', () => {
                quantityInput.value = Math.max(0, parseInt(quantityInput.value) - 1);
            });
        });

    </script>
{% endblock %}