{% extends 'base.html' %}

{% block content %}
    <div class="container">
        <div class="row">
            <div class="col">
                <h1>Flower List</h1>

                {% if user.is_superuser or user.is_staff %}
                    <div class="col-auto" style="left: 80%; padding-bottom: 10px">  <!-- This will take only the necessary width -->
                        <a href="{% url 'flowers:flower-create' %}" class="btn btn-primary mt-3">Create New Flower</a>
                    </div>
                {% endif %}

                <table class="table">
                    <thead>
                        <tr>
                            <th>Фото</th>
                            <th>Наименование</th>
                            <th>Цена</th>
                            <th>Количество</th>
                            <th>Купить</th>
                            <th>Доступное кол.</th>
                            {% if user.is_superuser or user.is_staff %}
                                <th>Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for flower in flowers %}
                            <tr>
                                <td>
                                    <a href="{% url 'flowers:flower-detail' flower.id %}">
                                        {% if flower.image %}
                                            <img src="{{ flower.image.url }}" alt="{{ flower.name }}" width="50">
                                        {% else %}
                                            <p>No image</p>
                                        {% endif %}
                                    </a>
                                </td>
                                <td>
                                    <a href="{% url 'flowers:flower-detail' flower.id %}">
                                        {{ flower.name }}
                                    </a>
                                </td>
                                <td>{{ flower.price }} RUB</td>
                                <td>
                                    <div class="quantity-control" style="display: flex; align-items: center; gap: 5px;">
                                        <button class="btn btn-sm btn-secondary decrement-btn">-</button>
                                        <label>
                                            <input type="number" class="form-control quantity-input" value="0" min="0" data-flower-id="{{ flower.id }}"
                                                   style="width: auto; min-width: 2em; max-width: 4em; text-align: center" id="quantityInput" data-stock={{ flower.stock }}>
                                        </label>
                                        <button class="btn btn-sm btn-secondary increment-btn">+</button>
                                    </div>
                                </td>
                                <td>
{#                                    TODO Check if add-to-cart is properly working#}
                                    <button class="btn btn-success add-to-cart-btn" data-flower-id="{{ flower.id }}">
                                        <i class="fas fa-shopping-cart"></i> Add to Cart
                                    </button>
                                </td>
                                <td>
                                    <p>{{ flower.stock }}</p>
                                </td>
                                <td>
                                    {% if user.is_superuser or user.is_staff %}
                                        <a href="{% url 'flowers:flower-update' flower.id %}" class="btn btn-primary">Update</a>
                                        <a href="{% url 'flowers:flower-delete' flower.id %}" class="btn btn-danger">Delete</a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>

                {% if flowers.has_other_pages %}
                    <ul class="pagination">
                        {% if flowers.has_previous %}
                            <li class="page-item"><a class="page-link" href="?page={{ flowers.previous_page_number }}">Previous</a></li>
                        {% endif %}
                        {% for page_number in flowers.paginator.page_range %}
                            <li class="page-item {% if page_number == flowers.number %}active{% endif %}">
                                <a class="page-link" href="?page={{ page_number }}">{{ page_number }}</a>
                            </li>
                        {% endfor %}
                        {% if flowers.has_next %}
                            <li class="page-item"><a class="page-link" href="?page={{ flowers.next_page_number }}">Next</a></li>
                        {% endif %}
                    </ul>
                {% endif %}
            </div>
        </div>
    </div>


    <script>
        const addToCartButtons = document.querySelectorAll('.add-to-cart-btn');
        addToCartButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const flowerId = button.dataset.flowerId;
                const quantityInput = document.querySelector(`input[data-flower-id="${flowerId}"]`);
                const quantity = parseInt(quantityInput.value);
        
                if (isNaN(quantity) || quantity <= 0) {
                    alert("Please enter a valid quantity (greater than 0).");
                    return; // Stop further execution if quantity is invalid
                }
        
                try {
                    const response = await fetch('/orders/add-to-cart/' + flowerId + '/', { // Adjust URL if needed
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken') //Important for CSRF protection
                        },
                        body: JSON.stringify({ quantity: quantity })
                    });
        
                    if (!response.ok) {
                        const errorData = await response.json();
                        const errorMessage = errorData.error || 'An error occurred while adding to cart.';
                        throw new Error(errorMessage); // Re-throw the error for handling below
                    }
        
                    const data = await response.json();
                    if(data.success){
                      alert("Item added to cart successfully!");
                      quantityInput.value = 0; //Reset quantity input
                    } else {
                      alert(data.message);
                    }
        
        
                } catch (error) {
                    console.error("Error adding to cart:", error);
                    alert('Error adding to cart: ' + error.message);
                }
            });
        });
        
        
        // Helper function to get CSRF token from cookie (for CSRF protection)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>


    <script>
        //JavaScript for quantity control
        const incrementButtons = document.querySelectorAll('.increment-btn');
        const decrementButtons = document.querySelectorAll('.decrement-btn');
        const quantityInput = document.getElementById("quantityInput");


        incrementButtons.forEach(button => {
            button.addEventListener('click', () => {
                const node = button.previousElementSibling.childNodes[1];
                node.value = Math.min(parseInt(node.dataset.stock),parseInt(node.value) + 1);
            });
        });

        decrementButtons.forEach(button => {
            button.addEventListener('click', () => {
                const node = button.nextElementSibling.childNodes[1];
                node.value = Math.max(0, parseInt(node.value) - 1);
            });
        });

    </script>
{% endblock %}